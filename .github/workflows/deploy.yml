name: Build & Verify

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
        
      - name: Build project
        run: npm run build
        env:
          GITHUB_ID: ${{ secrets.GITHUB_ID || '' }}
          GITHUB_SECRET: ${{ secrets.GITHUB_SECRET || '' }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET || 'test-secret' }}
          NEXTAUTH_URL: https://ai-news-bice.vercel.app
      
      - name: Verify build output
        run: |
          echo "Build artifacts:"
          ls -la .next/server/app/ 2>/dev/null || echo "Checking output..."
          echo ""
          echo "Checking API route..."
          if [ -f ".next/server/app/api/news/route.js" ]; then
            echo "‚úì API route built successfully"
          else
            echo "‚úó API route not found"
          fi
      
      - name: Wait for Vercel deployment
        if: always()
        run: |
          echo ""
          echo "Waiting for Vercel to deploy (Vercel auto-deploys on push)..."
          sleep 45
          
      - name: Verify deployment
        if: always()
        id: verify
        run: |
          # Check main page
          MAIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://ai-news-bice.vercel.app 2>/dev/null || echo "000")
          echo "main_status=$MAIN_STATUS" >> $GITHUB_OUTPUT
          
          # Check API
          API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://ai-news-bice.vercel.app/api/news 2>/dev/null || echo "000")
          echo "api_status=$API_STATUS" >> $GITHUB_OUTPUT
          
          # Check news count
          NEWS_COUNT=$(curl -s https://ai-news-bice.vercel.app/api/news 2>/dev/null | grep -o '"id"' | wc -l || echo 0)
          echo "news_count=$NEWS_COUNT" >> $GITHUB_OUTPUT
          
          echo ""
          echo "===================================="
          echo "Deployment Status:"
          echo "  Main page: HTTP $MAIN_STATUS"
          echo "  API: HTTP $API_STATUS"
          echo "  News items: $NEWS_COUNT"
          echo "===================================="
      
      - name: Report result
        if: always()
        run: |
          MAIN_STATUS=${{ steps.verify.outputs.main_status }}
          API_STATUS=${{ steps.verify.outputs.api_status }}
          
          if [ "$MAIN_STATUS" = "200" ] && [ "$API_STATUS" = "200" ]; then
            echo ""
            echo "‚úÖ Build & Deployment SUCCESSFUL!"
            echo ""
            echo "üåê Your app is live at: https://ai-news-bice.vercel.app"
            echo "üîê Login at: https://ai-news-bice.vercel.app/auth/signin"
          else
            echo ""
            echo "‚ö†Ô∏è Build passed but deployment may still be propagating"
            echo "   Vercel typically takes 1-2 minutes to deploy"
            echo ""
            echo "üìã Check deployment:"
            echo "   https://vercel.com/tourscholar/ai-news/deployments"
          fi
